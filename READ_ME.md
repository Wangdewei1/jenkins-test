# cpuäº²å’Œé”

å¼•å…¥ä¾èµ–
```shell
<dependency>
    <groupId>net.openhft</groupId>
    <artifactId>affinity</artifactId>
    <version>3.0.6</version>
</dependency>
```
ç¤ºä¾‹
```java
import net.openhft.affinity.Affinity;

public class AffinityExample {
    public static void main(String[] args) {
        // é”å®šåˆ° CPU 0
        Affinity.setAffinity(1L << 0);
        System.out.println("Thread pinned to CPU 0");

        while (true) {
            // æ¨¡æ‹Ÿä»»åŠ¡
        }
    }
}
```

æ³¨æ„:
- Affinity è®¾ç½®å¿…é¡»åœ¨å¯åŠ¨çº¿ç¨‹åè®¾ç½®ï¼Œå¦åˆ™æ— æ•ˆ
- CPU äº²å’Œæ€§å¯ä»¥ç”¨äºæå‡ç¼“å­˜å‘½ä¸­ç‡ã€å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚
- å¦‚æœæ˜¯çº¿ç¨‹æ± ï¼Œå»ºè®®åœ¨åˆ›å»ºçº¿ç¨‹æ—¶ç»‘å®š CPU


# ä¸€ã€ä»€ä¹ˆæ˜¯ CPU äº²å’Œæ€§ï¼ˆCPU Affinityï¼‰ï¼Ÿ
CPU äº²å’Œæ€§ æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºæ§åˆ¶ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹åªèƒ½è¿è¡Œåœ¨æŒ‡å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ª CPU æ ¸å¿ƒä¸Šã€‚
è¿™å°±åƒå‘Šè¯‰ç³»ç»Ÿï¼šâ€œè¿™ä¸ªçº¿ç¨‹åªèƒ½è·‘åœ¨ CPU 2 æˆ– CPU 3 ä¸Šï¼Œå…¶ä»– CPU åˆ«æ’æ‰‹ã€‚â€

# äºŒã€CPU äº²å’Œé”çš„æ ¸å¿ƒåŸç†
1. èƒŒæ™¯ï¼šçº¿ç¨‹è°ƒåº¦å’Œè¿ç§»
   ç°ä»£æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦å™¨æ˜¯â€œè´Ÿè½½å‡è¡¡â€çš„ï¼Œå®ƒä¼šåŠ¨æ€å°†çº¿ç¨‹åœ¨å¤šä¸ª CPU æ ¸å¿ƒä¹‹é—´è¿ç§»ï¼Œä»¥æå‡æ•´ä½“ç³»ç»Ÿååã€‚
   ä½†çº¿ç¨‹è¿ç§»å¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š
    - ç¼“å­˜å¤±æ•ˆï¼ˆCache Missï¼‰ï¼š
      - æ¯ä¸ª CPU æœ‰è‡ªå·±çš„ L1/L2/L3 ç¼“å­˜ï¼Œçº¿ç¨‹åœ¨ A æ ¸å¿ƒè¿è¡Œæ—¶ï¼Œç¼“å­˜äº†å¾ˆå¤šæ•°æ®ï¼›çªç„¶è¢«è¿ç§»åˆ° B æ ¸å¿ƒï¼Œå°±ä¸å¾—ä¸é‡æ–°åŠ è½½æ•°æ® â†’ å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
    - ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼š
      - å°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé¢‘ç¹åˆ‡æ¢çº¿ç¨‹ä¼šé€ æˆé¢å¤–å¼€é”€ã€‚
2. åŸç†æœ¬è´¨ï¼šé€šè¿‡è®¾ç½® CPU ä½å›¾ï¼Œå›ºå®šè¿è¡Œæ ¸å¿ƒ
   åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹/çº¿ç¨‹çš„è¿è¡Œæ ¸å¿ƒé€šè¿‡ CPU maskï¼ˆä½å›¾ï¼‰è¡¨ç¤ºï¼š
   ```text
   CPU mask: 00001000 â†’ è¡¨ç¤ºåªèƒ½è¿è¡Œåœ¨ CPU 3 ä¸Š
   ```
   ç³»ç»Ÿæä¾›çš„åº•å±‚è°ƒç”¨ï¼š
   ```shell
   int sched_setaffinity(pid_t pid, size_t cpusetsize, const cpu_set_t *mask);
   ```
   - pidï¼šè¿›ç¨‹ IDï¼Œ0 è¡¨ç¤ºå½“å‰çº¿ç¨‹
   - maskï¼šè¡¨ç¤ºå…è®¸è¿è¡Œåœ¨å“ªäº› CPU ä¸Š 
   - è®¾ç½®ä¹‹åï¼Œå†…æ ¸è°ƒåº¦å™¨å°±åªèƒ½åœ¨æŒ‡å®š CPU èŒƒå›´ä¸­åˆ†é…è¯¥çº¿ç¨‹
ğŸ’» ç¤ºä¾‹ï¼š
è®¾çº¿ç¨‹äº²å’Œæ€§ä¸º CPU 2ï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿçš„è°ƒåº¦å™¨å°±åªä¼šåœ¨ CPU 2 ä¸Šå®‰æ’è¿™ä¸ªçº¿ç¨‹è¿è¡Œï¼Œä¸ä¼šè¿ç§»åˆ°å…¶ä»–æ ¸ã€‚
# ä¸‰ã€ä¸ºä»€ä¹ˆèƒ½æå‡æ€§èƒ½ï¼Ÿ
| ä¼˜åŒ–ç‚¹             | æè¿°                                                                 |
|------------------|----------------------------------------------------------------------|
| ç¼“å­˜å‘½ä¸­ç‡æå‡     | çº¿ç¨‹æ€»åœ¨åŒä¸€ä¸ªæ ¸å¿ƒè¿è¡Œï¼Œæ•°æ®ä¿ç•™åœ¨è¯¥æ ¸å¿ƒçš„ L1/L2 ç¼“å­˜ä¸­ï¼Œä¸ç”¨é¢‘ç¹é‡å»ºç¼“å­˜ |
| å‡å°‘çº¿ç¨‹è¿ç§»å¼€é”€   | OS ä¸å†é¢‘ç¹è¿ç§»çº¿ç¨‹ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢                                     |
| é™ä½æŠ–åŠ¨å’Œå»¶è¿Ÿ     | åœ¨ä½å»¶è¿Ÿç³»ç»Ÿä¸­ï¼ˆå¦‚äº¤æ˜“ç³»ç»Ÿã€å®æ—¶éŸ³è§†é¢‘ï¼‰å°¤å…¶å…³é”®                        |
| çº¿ç¨‹ä¹‹é—´å¹²æ‰°æ›´å°‘   | ä¸åŒçº¿ç¨‹ç»‘å®šä¸åŒ CPUï¼Œå‡å°‘äº‰ç”¨ä¸åˆ‡æ¢æ—¶é—´                               |

| ä¸­æ–‡  |  è‹±æ–‡   |
|:---:|:-----:|
| ä½ å¥½  | hello |

# å››ã€åº”ç”¨åœºæ™¯
- é«˜é¢‘äº¤æ˜“ç³»ç»Ÿï¼ˆHFTï¼‰ 
- å®æ—¶éŸ³è§†é¢‘å¤„ç† 
- æ¸¸æˆå¼•æ“ 
- åµŒå…¥å¼/IoT ç³»ç»Ÿä¸­çš„ä»»åŠ¡è°ƒåº¦ 
- JVM é«˜æ€§èƒ½æœåŠ¡ä¸­çš„çº¿ç¨‹ä¼˜åŒ–ï¼ˆæ¯”å¦‚ Nettyã€Disruptorï¼‰

# äº”ã€é£é™©ä¸æ³¨æ„ç‚¹
| é—®é¢˜ |                       åŸå›                        |
|:---:|:---:|
|â— CPU ä¸å‡è¡¡ |             å¦‚æœç»‘å®šä¸åˆç†ï¼Œå¯èƒ½æœ‰çš„æ ¸å¾ˆå¿™ï¼Œæœ‰çš„æ ¸é—²ç€              |
|â— éš¾ä»¥è°ƒè¯• |               å¤šçº¿ç¨‹è°ƒåº¦è¡Œä¸ºæ›´â€œå›ºå®šâ€ï¼Œå¯è°ƒæ€§å˜å·®               |
|â— å’Œçº¿ç¨‹æ± å†²çª | å’Œ ForkJoinPoolã€çº¿ç¨‹æ± å¯èƒ½ä¸å…¼å®¹ï¼Œéœ€è¦é…åˆ ThreadFactory æ§åˆ¶  |

![img.png](img.png)

æ€ä¹ˆé…ç½®å‘¢ï¼Ÿ
# ä¸€ã€äº‘æœåŠ¡å™¨ä½¿ç”¨ CPU äº²å’Œé”çš„ é™åˆ¶
ğŸš« 1. æ— æ³•æ§åˆ¶ç‰©ç† CPU æ ¸å¿ƒ
äº‘æœåŠ¡æä¾›å•†ï¼ˆå¦‚ AWSã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰å°†ç‰©ç†æœºè™šæ‹Ÿæˆå¤šä¸ªç§Ÿæˆ·å®ä¾‹ã€‚
ä½ æ‹¿åˆ°çš„æ˜¯ vCPUï¼ˆè™šæ‹Ÿ CPUï¼‰ï¼Œå®ƒå¯èƒ½ä¼šåœ¨ç‰©ç†æœºä¸­ä¸æ–­è¿ç§»ã€‚
æ‰€ä»¥ä½ è®¾ç½®çš„ CPU äº²å’Œæ€§ï¼Œåªèƒ½åœ¨ è™šæ‹Ÿæ ¸èŒƒå›´å†…ç”Ÿæ•ˆï¼Œä¸ä¸€å®šæ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†æ ¸ã€‚
ğŸš« 2. å­˜åœ¨ vCPU æŠ¢å /æ¼‚ç§»
äº‘ç¯å¢ƒä¸­æœ‰å¯èƒ½å¤šä¸ªå®ä¾‹å…±äº«ä¸€ä¸ªç‰©ç† CPUï¼Œå­˜åœ¨èµ„æºæŠ¢å ã€å™ªå£°é‚»å±…ï¼ˆnoisy neighborï¼‰é—®é¢˜ã€‚
å³ä½¿ä½ ç»‘å®šäº† vCPU 0ï¼Œäº‘å¹³å°ä¹Ÿå¯èƒ½åœ¨åå°è¿ç§»åˆ°ç‰©ç† CPU 8ã€‚
ğŸš« 3. è¶…çº¿ç¨‹æ— æ³•å…³é—­
ä½ æ— æ³•æ§åˆ¶äº‘æœåŠ¡çš„ BIOS è®¾ç½®ï¼Œåƒ HTã€C-state å…³é—­ã€NUMA ç­‰éƒ½æ— æ³•é…åˆäº²å’Œä¼˜åŒ–ã€‚

# äºŒã€äº‘ä¸Šå¦‚ä½•â€œæ¨¡æ‹Ÿâ€äº²å’Œé”ä¼˜åŒ–ï¼Ÿ
è™½ç„¶ä¸èƒ½å®Œå…¨æ§åˆ¶ CPUï¼Œä½†å¯ä»¥å°½é‡æ¨¡æ‹Ÿäº²å’Œé”çš„ä¼˜åŒ–æ€æƒ³ï¼š
âœ… 1. é€‰æ‹© ä¸“å±å‹å®ä¾‹ æˆ– è£¸é‡‘å±å®ä¾‹
å®ä¾‹ç±»å‹	ç‰¹ç‚¹	æ¨èç”¨é€”
é€šç”¨å…±äº«å‹ï¼ˆå¦‚ AWS t4gï¼‰	æ€§èƒ½æ³¢åŠ¨å¤§	âŒ ä¸é€‚åˆé«˜é¢‘äº¤æ˜“
è®¡ç®—å¢å¼ºå‹ï¼ˆå¦‚ c7ã€c6iï¼‰	è¾ƒç¨³å®šï¼Œæ€§ä»·æ¯”é«˜	âœ… ä¸­ç­‰çº§åˆ«å»¶è¿Ÿ
ä¸“å±å‹å®ä¾‹ï¼ˆdedicated hostï¼‰	ä¸€æ•´ä¸ªç‰©ç†æœºåªç»™ä½ 	âœ… é«˜æ€§èƒ½äº¤æ˜“é¦–é€‰
è£¸é‡‘å±å®ä¾‹ï¼ˆbare metalï¼‰	æ— è™šæ‹ŸåŒ–å±‚ï¼Œå®Œå…¨æ§åˆ¶ç‰©ç†æœº	âœ…âœ… æœ€æ¥è¿‘ç‰©ç†æœºæ€§èƒ½
ğŸ‘‰ ä¾‹å¦‚ï¼š
- é˜¿é‡Œäº‘ï¼šecs.g7e.largeï¼ˆä¸“å±å‹ï¼‰
- AWSï¼šmetal ç³»åˆ—ï¼ˆc6gn.metalï¼‰
- è…¾è®¯äº‘ï¼šSA3ã€SN3neè£¸é‡‘å±æœåŠ¡å™¨

è°ƒæ•´ JVM + OS ä¼˜åŒ–é¡¹
JVM ç»‘å®šçº¿ç¨‹äº²å’Œæ€§ï¼ˆAffinity.setAffinity()ï¼‰
è®¾ç½® isolcpus å’Œ nohz_fullï¼Œå°†å…³é”®çº¿ç¨‹ç‹¬å æŸäº› vCPU
å…³é—­ Linux C-Stateï¼Œä½¿ç”¨ Performance governor æ¨¡å¼
å¼€å¯ RPS/XPS è°ƒæ•´ç½‘å¡æ”¶å‘åŒ…æ ¸å¿ƒï¼Œé…åˆ NUMA ä¼˜åŒ–

# ä¸‰ã€é€‚åˆäº‘ä¸Šçš„é«˜é¢‘äº¤æ˜“ä¼˜åŒ–è·¯å¾„
ä¼˜åŒ–ç»´åº¦	äº‘ä¸Šæ›¿ä»£ç­–ç•¥
CPU äº²å’Œ	ç”¨ taskset å›ºå®š vCPU + ä½¿ç”¨ä¸“å±/è£¸é‡‘å±å®ä¾‹
Cache å‘½ä¸­	ä½¿ç”¨ Disruptor ç­‰æ— é”é˜Ÿåˆ—ï¼Œå°½é‡æ•°æ®å±€éƒ¨åŒ–
ç½‘ç»œä¼˜åŒ–	é…ç½® DPDK ç½‘å¡æˆ–å¼€å¯ SR-IOVã€RDMAï¼ˆéƒ¨åˆ†äº‘å¹³å°æ”¯æŒï¼‰
ç³»ç»Ÿå»¶è¿Ÿ	ä½¿ç”¨ clocksource=tsc, ç¦ç”¨ C-state, å›ºå®šä¸»é¢‘
å™ªå£°éš”ç¦»	ä½¿ç”¨ dedicated host æˆ– bare metal é¿å…é‚»å±…å¹²æ‰°
